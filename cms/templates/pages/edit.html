{% extends "base.html" %}
{% set title = "Edit " + ((page.type or "page")|title) %}

{% block content %}
<div class="container-fluid">
    <!-- Add Template Block Form (Independent) -->
    <form method="post" action="{{ url_for('pages.edit_page', page_id=page.id) }}" class="d-none" id="addTemplateForm" onsubmit="return validateTemplateSelection(this)">
        {{ csrf_field() }}
        <input type="hidden" name="action" value="add_template">
        <input type="hidden" name="template_id" id="selectedTemplateId">
    </form>

    <!-- Remove Template Form (Independent) -->
    <form method="post" action="{{ url_for('pages.edit_page', page_id=page.id) }}" class="d-none" id="removeTemplateForm">
        {{ csrf_field() }}
        <input type="hidden" name="action" value="remove_template">
        <input type="hidden" name="page_template_id" id="removeTemplateId">
    </form>

    <!-- Mode Toggle Button (Outside main form) -->
    <div class="row mb-3">
        <div class="col-12">
            <form method="post" style="display: inline;">
                {{ csrf_field() }}
                <input type="hidden" name="action" value="toggle_mode">
                <button type="submit" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-{% if page.mode == 'simple' %}gear{% else %}eye{% endif %}"></i> 
                    {% if page.mode == 'simple' %}Show Advanced Mode{% else %}Show Simple Mode{% endif %}
                </button>
            </form>
            <small class="text-muted ms-2">Current mode: {{ page.mode.title() }}</small>
        </div>
    </div>

    <form method="post" id="pageForm" onsubmit="return validatePageForm()" enctype="multipart/form-data">
        {{ csrf_field() }}
        <input type="hidden" name="action" value="save">

        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h1 class="mb-0">Edit {{ (page.type or "page")|title }}</h1>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('pages.pages', type='blog' if page.type == 'blog' else 'page') }}" class="btn btn-outline-secondary rounded-pill">
                            <i class="bi bi-arrow-left"></i> Back to {{ 'Blog Articles' if page.type == 'blog' else 'Pages' }}
                        </a>
                        <button type="submit" class="btn btn-primary rounded-pill">
                            <i class="bi bi-save"></i> Save Page
                        </button>
                        <a href="{{ url_for('pages.preview_page', page_id=page.id) }}" class="btn btn-outline-info rounded-pill" target="_blank">
                            <i class="bi bi-eye"></i> Preview
                        </a>
                        <button type="submit" formaction="{{ url_for('pages.publish_page', page_id=page.id) }}" class="btn btn-success rounded-pill">
                            <i class="bi bi-upload"></i> {% if page.published %}Re-publish{% else %}Publish{% endif %}
                        </button>
                        <button type="submit" formaction="{{ url_for('pages.delete_page', page_id=page.id) }}"
                                class="btn btn-outline-danger rounded-pill"
                                onclick="return confirm('Are you sure you want to delete this page?')">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
                {% if page_template_label %}
                <div class="mb-4">
                    <span class="badge bg-secondary">Template: {{ page_template_label }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Page Title and Slug Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="page_title" class="form-label fw-bold">Title</label>
                                    <input type="text" class="form-control" id="page_title" name="page_title" 
                                           value="{{ page.title }}" required oninput="generateSlug()">
                                    <div class="form-text">The display title for this page</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="page_slug" class="form-label fw-bold">Slug</label>
                                    <input type="text" class="form-control" id="page_slug" name="page_slug" 
                                           value="{{ page.slug }}" required>
                                    <div class="form-text">URL-friendly version of the title (e.g., "my-page")</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check" {% if page.type == 'blog' %}style="display:none;"{% endif %}>
                                    <input class="form-check-input" type="checkbox" id="is_blog_container" name="is_blog_container" {% if page.is_blog_container %}checked{% endif %}>
                                    <label class="form-check-label" for="is_blog_container">
                                        Used for Blog
                                    </label>
                                    <div class="form-text">Mark this page as the blog listing/container. It will be re-published every time a blog is added/updated so that the index is regenerated.</div>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-center justify-content-end">
                                <span class="badge bg-secondary">Type: {{ (page.type or 'page')|title }}</span>
                            </div>
                        </div>
                        {% if page.type == 'blog' %}
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="page_excerpt" class="form-label fw-bold">Excerpt</label>
                                    <textarea class="form-control" id="page_excerpt" name="page_excerpt" rows="3" placeholder="Short summary for listings">{{ page.excerpt or '' }}</textarea>
                                    <div class="form-text">Optional short summary used in blog listings and previews.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="page_author" class="form-label fw-bold">Author</label>
                                    <input type="text" class="form-control" id="page_author" name="page_author" value="{{ page.author or '' }}" placeholder="Author name">
                                    <div class="form-text">Author of this blog post (defaults to current user)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="page_published_date" class="form-label fw-bold">Published Date</label>
                                    <input type="date" class="form-control" id="page_published_date" name="page_published_date" value="{{ (page.published_date or page.created_at)[:10] }}">
                                    <div class="form-text">Publication date for this blog post (defaults to creation date)</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Featured Image</label>
                                    {% if page.featured_png or page.featured_webp %}
                                    <div class="mb-3">
                                        <!-- Thumbnail Display -->
                                        <div class="mb-2">
                                            <img src="{{ base_url }}{{ (page.featured_png or page.featured_webp).replace('.png','-thumb.png').replace('.webp','-thumb.webp') }}" alt="Featured" style="max-width: 200px; height: auto; border: 1px solid #ddd; border-radius: 4px;"/>
                                        </div>
                                        
                                        <!-- Copy URL Buttons (Advanced Mode Only) -->
                                        {% if page.mode == 'advanced' %}
                                        <div class="mb-2">
                                            <label class="form-label fw-bold small">Image URLs:</label>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">PNG</span>
                                                        <input type="text" class="form-control font-monospace small" value="{{ base_url }}{{ page.featured_png or '' }}" readonly id="featured-png-url">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('featured-png-url')" title="Copy PNG URL">
                                                            <i class="bi bi-clipboard"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">WebP</span>
                                                        <input type="text" class="form-control font-monospace small" value="{{ base_url }}{{ page.featured_webp or '' }}" readonly id="featured-webp-url">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('featured-webp-url')" title="Copy WebP URL">
                                                            <i class="bi bi-clipboard"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Thumb PNG</span>
                                                        <input type="text" class="form-control font-monospace small" value="{{ base_url }}{{ (page.featured_png or page.featured_webp).replace('.png','-thumb.png').replace('.webp','-thumb.webp') }}" readonly id="featured-thumb-png-url">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('featured-thumb-png-url')" title="Copy Thumbnail PNG URL">
                                                            <i class="bi bi-clipboard"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Thumb WebP</span>
                                                        <input type="text" class="form-control font-monospace small" value="{{ base_url }}{{ (page.featured_png or page.featured_webp).replace('.png','-thumb.png').replace('.webp','-thumb.webp') }}" readonly id="featured-thumb-webp-url">
                                                        <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('featured-thumb-webp-url')" title="Copy Thumbnail WebP URL">
                                                            <i class="bi bi-clipboard"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Remove Button -->
                                        <div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFeaturedImage()">
                                                <i class="bi bi-trash"></i> Remove Featured Image
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <input class="form-control" type="file" name="featured_image" accept="image/*">
                                    <div class="form-text">Upload a featured image. It will be resized to 1600x1600px and 300x300px thumbnail, saved as PNG and WebP formats.</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Categories</label>
                                    <div>
                                        {% for cat in blog_categories %}
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="cat_{{ cat.id }}" name="category_ids" value="{{ cat.id }}" {% if cat.id in selected_categories %}checked{% endif %}>
                                            <label class="form-check-label" for="cat_{{ cat.id }}">{{ cat.title }}</label>
                                        </div>
                                        {% endfor %}
                                        {% if not blog_categories %}
                                            <div class="text-muted">No categories yet. Add some from the Blog list page.</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% if page.mode == 'advanced' %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>Template Blocks</h5>
                        <div class="d-flex gap-2">
                            <select id="templateSelect" class="form-select form-select-sm" style="width: auto;">
                                <option value="">Select template block to add...</option>
                                {% for template in available_templates %}
                                    <option value="{{ template.id }}">{{ template.title }} ({{ template.category }})</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addSelectedTemplate()">
                                <i class="bi bi-plus"></i> Add Block
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="templateBlocks">
                            {% for pt in page_templates %}
                            <div class="template-block mb-3 system-block-{{ pt.category }}" id="block-{{ pt.id }}">
                                <div class="template-block-header" onclick="toggleBlockContent({{ pt.id }})" style="cursor: pointer;">
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-grip-vertical drag-handle" onclick="event.stopPropagation();" title="Drag to reorder"></i>
                                            <div class="sort-buttons ms-1">
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); moveBlock({{ pt.id }}, 'up')">
                                                    <i class="bi bi-chevron-up"></i>
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); moveBlock({{ pt.id }}, 'down')">
                                                    <i class="bi bi-chevron-down"></i>
                                                </button>
                                            </div>
                                            <input type="text" class="form-control form-control-sm bg-transparent fw-bold editable-title ms-2" 
                                                   name="title_{{ pt.id }}" value="{{ pt.custom_title or pt.title }}" 
                                                   placeholder="{{ pt.title }}" style="width: auto; min-width: 150px;" onclick="event.stopPropagation();">
                                            {% set template_count = page_templates | selectattr('template_id', 'equalto', pt.template_id) | list | length %}
                                            {% if template_count > 1 %}
                                                {% set instance_num = page_templates[:loop.index] | selectattr('template_id', 'equalto', pt.template_id) | list | length %}
                                                <span class="badge bg-info ms-1">#{{ instance_num }}</span>
                                            {% endif %}
                                            <span class="badge bg-{{ 'primary' if pt.category == 'system' else 'success' }} ms-2">{{ pt.category.title() }}</span>
                                            {% if pt.category != 'system' %}
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" title="Insert Media" onclick="event.stopPropagation(); openMediaPicker('template_{{ pt.id }}')">
                                                <i class="bi bi-image"></i>
                                            </button>
                                            {% endif %}
                                            <i class="bi bi-chevron-down ms-2" id="expand-icon-{{ pt.id }}" style="transition: transform 0.2s ease;"></i>
                                        </div>
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); removeBlock({{ pt.id }})" title="Remove template block">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="template-block-content collapse" id="content-{{ pt.id }}">
                                    <div class="p-3">
                                        <input type="hidden" name="sort_order_{{ pt.id }}" value="{{ pt.sort_order }}">
                                        
                                        {% if pt.has_parameters %}
                                        <!-- Block parameters section -->
                                        <div class="mb-4">
                                            <h6 class="text-muted mb-3">Block Parameters:</h6>
                                            <div id="parameters-{{ pt.id }}">
                                                {% for param_info in pt.parameter_info %}
                                                <div class="mb-3">
                                                    <label class="form-label small">
                                                        {{ param_info.name }}
                                                        {% if param_info.type != 'text' %}
                                                            <span class="badge bg-secondary ms-1">{{ param_info.type }}</span>
                                                        {% endif %}:
                                                    </label>
                                                    {% if param_info.type == 'code' %}
                                                        <textarea class="form-control form-control-sm code-html" 
                                                                  name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                                  rows="6" 
                                                                  placeholder="Enter code for {{ param_info.name }}">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                                    {% elif param_info.type == 'wysiwyg' %}
                                                        <div class="wysiwyg-editor" data-target="param_{{ pt.id }}_{{ param_info.name }}">
                                                            <div class="d-flex justify-content-end mb-2">
                                                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-wysiwyg-code" data-quill-id="quill_{{ pt.id }}_{{ param_info.name }}">
                                                                    <i class="bi bi-code-slash"></i> Edit HTML
                                                                </button>
                                                            </div>
                                                            <div class="quill-container" id="quill_{{ pt.id }}_{{ param_info.name }}"></div>
                                                            <textarea class="form-control form-control-sm wysiwyg-textarea" 
                                                                      name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                                      rows="4" 
                                                                      placeholder="Enter content for {{ param_info.name }}"
                                                                      style="display: none;">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                                        </div>
                                                    {% else %}
                                                        <textarea class="form-control form-control-sm" 
                                                                  name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                                  rows="4" 
                                                                  placeholder="Enter content for {{ param_info.name }}">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                                    {% endif %}
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Template code section (always below parameters) -->
                                        <div class="mb-2">
                                            <h6 class="text-muted mb-2">Template Block Code:</h6>
                                            <div class="form-check mb-2">
                                                <input type="checkbox" class="form-check-input use-default-checkbox"
                                                       id="use_default_{{ pt.id }}" name="use_default_{{ pt.id }}"
                                                       {{ 'checked' if pt.use_default else '' }}
                                                       onchange="toggleDefaultContent(this, 'template_{{ pt.id }}')">
                                                <label class="form-check-label" for="use_default_{{ pt.id }}">
                                                    Use default template content
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <textarea class="form-control code-html {{ 'grayed-textarea' if pt.use_default else '' }}"
                                                  id="template_{{ pt.id }}" name="template_{{ pt.id }}"
                                                  rows="15" {{ 'readonly' if pt.use_default else '' }}>{{ pt.custom_content if not pt.use_default else pt.default_content }}</textarea>
                                        <input type="hidden" id="default_content_{{ pt.id }}" value="{{ pt.default_content }}">
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Simple Mode: Show only parameters -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Page Content</h5>
                    </div>
                    <div class="card-body">
                        {% for pt in page_templates %}
                            {% if pt.has_parameters %}
                            <div class="mb-4">
                                <h6 class="text-primary mb-3">{{ pt.title or 'Untitled Block' }}</h6>
                                {% for param_info in pt.parameter_info %}
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        {{ param_info.name }}
                                        {% if param_info.type != 'text' %}
                                            <span class="badge bg-secondary ms-1">{{ param_info.type }}</span>
                                        {% endif %}:
                                    </label>
                                    {% if param_info.type == 'code' %}
                                        <textarea class="form-control code-html" 
                                                  name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                  rows="6" 
                                                  placeholder="Enter code for {{ param_info.name }}">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                    {% elif param_info.type == 'wysiwyg' %}
                                        <div class="wysiwyg-editor" data-target="param_{{ pt.id }}_{{ param_info.name }}">
                                            <div class="d-flex justify-content-end mb-2">
                                                <button type="button" class="btn btn-sm btn-outline-secondary toggle-wysiwyg-code" data-quill-id="quill_{{ pt.id }}_{{ param_info.name }}">
                                                    <i class="bi bi-code-slash"></i> Edit HTML
                                                </button>
                                            </div>
                                            <div class="quill-container" id="quill_{{ pt.id }}_{{ param_info.name }}"></div>
                                            <textarea class="form-control wysiwyg-textarea" 
                                                      name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                      rows="4" 
                                                      placeholder="Enter content for {{ param_info.name }}"
                                                      style="display: none;">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                        </div>
                                    {% else %}
                                        <textarea class="form-control" 
                                                  name="param_{{ pt.id }}_{{ param_info.name }}" 
                                                  rows="4" 
                                                  placeholder="Enter content for {{ param_info.name }}">{{ pt.parameters.get(param_info.name, '') }}</textarea>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        {% endfor %}
                        {% if not page_templates or not page_templates|selectattr('has_parameters')|list %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-info-circle fs-1"></i>
                            <p class="mt-3">No content blocks with parameters found.</p>
                            <p>Switch to Advanced Mode to add template blocks.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% if page.mode == 'advanced' %}
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Advanced Mode Help</h5>
                    </div>
                    <div class="card-body">
                        <div class="small text-muted">
                            Tips: Use <code>{{ "{{page:title}}" }}</code>, <code>{{ "{{page:excerpt}}" }}</code>, <code>{{ "{{page:featured:png}}" }}</code>, <code>{{ "{{page:featured:webp}}" }}</code>, <code>{{ "{{blog:categories}}" }}</code>, <code>{{ "{{blog:category:[ID]}}" }}</code>.
                            Conditionals: <code>{{ "{{if page:featured}}...{{/if}}" }}</code>, <code>{{ "{{if page:excerpt}}...{{/if}}" }}</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
.template-block-content {
    transition: all 0.3s ease;
    overflow: hidden;
}

.template-block-content:not(.show) {
    max-height: 0;
    padding: 0;
}

.template-block-content.show {
    max-height: 2000px;
}

/* Media Picker Styles */
.media-picker-card { 
    overflow: hidden; 
    min-height: 200px;
    height: 100%;
}

.media-picker-card .overlay {
    position: absolute; inset: 0; background: rgba(0,0,0,0.75);
    opacity: 0; transition: opacity .15s ease-in-out; color: #fff;
    display: flex; align-items: flex-start; justify-content: center;
    overflow-y: auto;
    padding: 0.5rem;
    pointer-events: none;
}
.media-picker-card:hover .overlay { opacity: 1; }
.media-picker-card .btn { white-space: nowrap; pointer-events: auto; }

.media-picker-card .url-container {
    width: 100%;
    max-height: 100%;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    justify-content: flex-start;
}

.media-picker-card .url-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

/* Editable Title Styling */
.editable-title {
    border: 1px solid #dee2e6 !important;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.editable-title:hover {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.editable-title:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    outline: 0;
}

/* Template Block Layout Improvements */
.template-block-content .mb-4 {
    margin-bottom: 1.5rem !important;
}

.template-block-header {
    border-bottom: 1px solid #dee2e6;
    padding: 0.75rem 1rem;
    background-color: #f8f9fa;
}

.template-block {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    background-color: #fff;
    transition: all 0.2s ease;
}

.template-block:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.template-block.sortable-ghost {
    opacity: 0.4;
    background-color: #f8f9fa;
}

.template-block.sortable-chosen {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.drag-handle {
    cursor: move;
    color: #6c757d;
    padding: 0.25rem;
    margin-right: 0.5rem;
    border-radius: 0.25rem;
    transition: color 0.2s ease;
}

.drag-handle:hover {
    color: #495057;
    background-color: #f8f9fa;
}

/* CMS Block Indentation */
.template-block.indented {
    margin-left: 50px;
    border-left: 3px solid #e9ecef;
    padding-left: 10px;
    transition: margin-left 0.3s ease, border-left-color 0.3s ease;
}

.template-block.indented:hover {
    border-left-color: #dee2e6;
}

/* Nested indentation levels */
.template-block.indent-level-1 { margin-left: 50px; }
.template-block.indent-level-2 { margin-left: 100px; }
.template-block.indent-level-3 { margin-left: 150px; }
.template-block.indent-level-4 { margin-left: 200px; }
.template-block.indent-level-5 { margin-left: 250px; }

/* Visual indicator for indented blocks */
.template-block.indented::before {
    content: '';
    position: absolute;
    left: -3px;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(to bottom, #e9ecef, #f8f9fa);
    border-radius: 2px;
}

/* CMS Tag indicator */
.cms-tag-indicator {
    font-size: 0.75rem;
    color: #6c757d;
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    margin-right: 0.5rem;
    border: 1px solid #dee2e6;
    white-space: nowrap;
}

.cms-tag-indicator.open-tag {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

.cms-tag-indicator.close-tag {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
}

/* Parameter Type Styles */
.parameter-type-badge {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 3px;
}

.wysiwyg-editor {
    position: relative;
}

.wysiwyg-editor .form-control {
    min-height: 100px;
    resize: vertical;
}

.wysiwyg-editor.edit-html-mode .quill-container {
    display: none;
}

.wysiwyg-editor.edit-html-mode .wysiwyg-textarea {
    display: block !important;
}

/* Quill Editor Styling */
.quill-container {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    background: white;
}

.quill-container .ql-editor {
    min-height: 120px;
    font-size: 14px;
    line-height: 1.5;
}

.quill-container .ql-toolbar {
    border-bottom: 1px solid #ced4da;
    border-top-left-radius: 0.375rem;
    border-top-right-radius: 0.375rem;
}

.quill-container .ql-container {
    border-bottom-left-radius: 0.375rem;
    border-bottom-right-radius: 0.375rem;
}

/* Focus state for Quill */
.quill-container:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Hide textarea when Quill is active */
.wysiwyg-textarea {
    display: none !important;
}

/* Code editor styling for parameter inputs */
.param-code-editor {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
}

/* Parameter CodeMirror styling */
.CodeMirror {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    line-height: 1.5;
}

.CodeMirror:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* Ensure proper positioning for parameter code editors */
textarea.code-html[class*="param"] + .CodeMirror {
    margin-top: 0;
    margin-left: 0;
}

/* Advanced mode parameter code editor styling */
.advanced-mode .CodeMirror {
    width: 100%;
    margin: 0;
    padding: 0;
}

.advanced-mode .CodeMirror .CodeMirror-gutters {
    border-right: 1px solid #dee2e6;
    background-color: #f8f9fa;
    min-width: 3em;
}

.advanced-mode .CodeMirror .CodeMirror-linenumber {
    color: #6c757d;
    padding: 0 8px;
    min-width: 2.5em;
    text-align: right;
}

.advanced-mode .CodeMirror .CodeMirror-lines {
    padding-left: 8px;
}

/* General CodeMirror line number spacing fix */
.CodeMirror .CodeMirror-gutters {
    min-width: 3em;
}

.CodeMirror .CodeMirror-linenumber {
    min-width: 2.5em;
    text-align: right;
    padding-right: 8px;
}

.CodeMirror .CodeMirror-lines {
    padding-left: 8px;
}
</style>
<script>
// Initialize drag and drop sorting
let sortableBlocks = null;

function initializeSortable() {
    const templateBlocks = document.getElementById('templateBlocks');
    if (templateBlocks && window.Sortable) {
        sortableBlocks = new Sortable(templateBlocks, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            handle: '.drag-handle',
            onEnd: function(evt) {
                updateSortOrder();
                calculateBlockIndentation(); // Recalculate indentation after reordering
            }
        });
    }
}

// Template block sorting (legacy function for up/down buttons)
function moveBlock(pageTemplateId, direction) {
    const block = document.getElementById('block-' + pageTemplateId);
    const container = block.parentElement;

    if (direction === 'up') {
        const prevBlock = block.previousElementSibling;
        if (prevBlock) {
            container.insertBefore(block, prevBlock);
        }
    } else {
        const nextBlock = block.nextElementSibling;
        if (nextBlock) {
            container.insertBefore(nextBlock, block);
        }
    }

    // Update sort order inputs
    updateSortOrder();
    
    // Recalculate indentation after reordering
    calculateBlockIndentation();
}

function updateSortOrder() {
    const container = document.getElementById('templateBlocks');
    if (!container) return;
    
    const blocks = container.querySelectorAll('[id^="block-"]');
    blocks.forEach((block, index) => {
        const sortInput = block.querySelector('input[name^="sort_order_"]');
        if (sortInput) {
            sortInput.value = index;
        }
    });
}

// Toggle default content
function toggleDefaultContent(checkbox, textareaId) {
    const textarea = document.getElementById(textareaId);
    if (checkbox.checked) {
        textarea.classList.add('grayed-textarea');
        textarea.readOnly = true;
        // Load default content
        const defaultContentId = textareaId.replace('template_', 'default_content_');
        const defaultContent = document.getElementById(defaultContentId);
        if (defaultContent) {
            // Hidden input stores default content in value attribute
            const value = defaultContent.value !== undefined ? defaultContent.value : defaultContent.textContent;
            textarea.value = value || '';
        }
        // If CodeMirror is attached, set readOnly there too
        const cm = (textarea && textarea._cm) || (textarea && textarea.nextElementSibling && textarea.nextElementSibling.CodeMirror) || null;
        if (cm) {
            cm.setOption('readOnly', true);
            cm.setValue(textarea.value);
            cm.refresh();
        }
        // If Quill is attached, set readOnly there too
        const quillContainer = textarea.previousElementSibling;
        if (quillContainer && quillContainer._quill) {
            quillContainer._quill.enable(false);
            quillContainer._quill.root.innerHTML = textarea.value;
        }
    } else {
        textarea.classList.remove('grayed-textarea');
        textarea.readOnly = false;
        // If CodeMirror is attached, disable readOnly so it becomes editable
        const cm = (textarea && textarea._cm) || (textarea && textarea.nextElementSibling && textarea.nextElementSibling.CodeMirror) || null;
        if (cm) {
            cm.setOption('readOnly', false);
            cm.refresh();
            // Optionally focus so user can start typing immediately
            cm.focus();
        }
        // If Quill is attached, enable it so it becomes editable
        const quillContainer = textarea.previousElementSibling;
        if (quillContainer && quillContainer._quill) {
            quillContainer._quill.enable(true);
            quillContainer._quill.focus();
        }
    }
}

</script>
<!-- Media Picker Modal -->
<div class="modal" tabindex="-1" id="mediaPickerModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Insert Media</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row" id="mediaPickerGrid"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
 </div>

<!-- Image Size Modal -->
<div class="modal" tabindex="-1" id="imageSizeModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Image Size</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Original Format URLs:</h6>
            <div class="mb-3">
              <label class="form-label">Small:</label>
              <input type="text" class="form-control" id="size-modal-small" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Medium:</label>
              <input type="text" class="form-control" id="size-modal-medium" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Large:</label>
              <input type="text" class="form-control" id="size-modal-large" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Original:</label>
              <input type="text" class="form-control" id="size-modal-orig" readonly onclick="this.select()">
            </div>
          </div>
          <div class="col-md-6">
            <h6>WebP Format URLs:</h6>
            <div class="mb-3">
              <label class="form-label">Small WebP:</label>
              <input type="text" class="form-control" id="size-modal-small-webp" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Medium WebP:</label>
              <input type="text" class="form-control" id="size-modal-medium-webp" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Large WebP:</label>
              <input type="text" class="form-control" id="size-modal-large-webp" readonly onclick="this.select()">
            </div>
            <div class="mb-3">
              <label class="form-label">Original WebP:</label>
              <input type="text" class="form-control" id="size-modal-orig-webp" readonly onclick="this.select()">
            </div>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-12">
            <h6>Pre-written Picture Tags:</h6>
            <div class="mb-3">
              <label class="form-label">Small Size:</label>
              <textarea class="form-control" id="size-modal-picture-small" rows="3" readonly onclick="this.select()"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Medium Size:</label>
              <textarea class="form-control" id="size-modal-picture-medium" rows="3" readonly onclick="this.select()"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Large Size:</label>
              <textarea class="form-control" id="size-modal-picture-large" rows="3" readonly onclick="this.select()"></textarea>
            </div>
          </div>
        </div>
        
        <!-- Quill Image Insertion Buttons -->
        <div class="row mt-4" id="quill-insert-buttons" style="display: none;">
          <div class="col-12">
            <h6>Insert into WYSIWYG Editor:</h6>
            <div class="d-flex gap-2 flex-wrap">
              <button type="button" class="btn btn-primary btn-sm" onclick="insertImageIntoQuill(document.getElementById('size-modal-small').value, document.getElementById('size-modal-small').alt || 'Image', document.getElementById('size-modal-small').title || 'Image')">
                Insert Small
              </button>
              <button type="button" class="btn btn-primary btn-sm" onclick="insertImageIntoQuill(document.getElementById('size-modal-medium').value, document.getElementById('size-modal-medium').alt || 'Image', document.getElementById('size-modal-medium').title || 'Image')">
                Insert Medium
              </button>
              <button type="button" class="btn btn-primary btn-sm" onclick="insertImageIntoQuill(document.getElementById('size-modal-large').value, document.getElementById('size-modal-large').alt || 'Image', document.getElementById('size-modal-large').title || 'Image')">
                Insert Large
              </button>
              <button type="button" class="btn btn-primary btn-sm" onclick="insertImageIntoQuill(document.getElementById('size-modal-orig').value, document.getElementById('size-modal-orig').alt || 'Image', document.getElementById('size-modal-orig').title || 'Image')">
                Insert Original
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script>
let activeEditor = null;
function openMediaPicker(targetTextareaId) {
    // Set active editor as the provided textarea or currently focused editor
    activeEditor = targetTextareaId ? document.getElementById(targetTextareaId) : document.activeElement;
    if (!activeEditor) activeEditor = document.activeElement;
    if (activeEditor && activeEditor.classList.contains && activeEditor.classList.contains('CodeMirror-focused')) {
        activeEditor = activeEditor.closest('.CodeMirror').previousSibling;
    }
    fetch('{{ url_for('media.media_list_json') }}').then(r => r.json()).then(data => {
        const grid = document.getElementById('mediaPickerGrid');
        grid.innerHTML = '';
        
        // Store media data for image size modal
        mediaData = {};
        (data.media || []).forEach(item => {
            mediaData[item.id] = item;
            const col = document.createElement('div');
            col.className = 'col-6 col-md-3 mb-3';
            col.innerHTML = `<div class="card h-100 position-relative media-picker-card">
                <img src="${item.small || item.original}" class="card-img-top" alt="${item.alt}" 
                     style="cursor: pointer; height: 150px; object-fit: cover;" 
                     onclick="openImageSizeModal(${item.id})">
                <div class="card-body p-2">
                  <div class="small text-truncate" title="${item.title}">${item.title}</div>
                </div>
                <div class="overlay p-1">
                  <div class="url-container">
                    <div class="url-item">
                      <button type="button" class="btn btn-sm btn-primary w-100" onclick="openImageSizeModal(${item.id})">Choose image size</button>
                    </div>
                  </div>
                </div>
              </div>`;
            grid.appendChild(col);
        });
        const modal = new bootstrap.Modal(document.getElementById('mediaPickerModal'));
        modal.show();
    });
}

// Store media data for image size modal
let mediaData = {};

function openImageSizeModal(mediaId) {
    const data = mediaData[mediaId];
    if (!data) return;
    
    // Populate URLs
    document.getElementById('size-modal-orig').value = data.original;
    document.getElementById('size-modal-small').value = data.small;
    document.getElementById('size-modal-medium').value = data.medium;
    document.getElementById('size-modal-large').value = data.large;
    document.getElementById('size-modal-orig-webp').value = data.original_webp;
    document.getElementById('size-modal-small-webp').value = data.small_webp;
    document.getElementById('size-modal-medium-webp').value = data.medium_webp;
    document.getElementById('size-modal-large-webp').value = data.large_webp;
    
    // Generate picture tags
    const title = data.title || 'Image';
    const alt = data.alt || title;
    
    document.getElementById('size-modal-picture-small').value = 
        `<picture>\n  <source srcset="${data.small_webp}" type="image/webp">\n  <img src="${data.small}" alt="${alt}" title="${title}">\n</picture>`;
    
    document.getElementById('size-modal-picture-medium').value = 
        `<picture>\n  <source srcset="${data.medium_webp}" type="image/webp">\n  <img src="${data.medium}" alt="${alt}" title="${title}">\n</picture>`;
    
    document.getElementById('size-modal-picture-large').value = 
        `<picture>\n  <source srcset="${data.large_webp}" type="image/webp">\n  <img src="${data.large}" alt="${alt}" title="${title}">\n</picture>`;
    
    // Show/hide Quill insertion buttons based on whether a Quill editor is active
    const quillButtons = document.getElementById('quill-insert-buttons');
    if (window.currentQuillEditor) {
        quillButtons.style.display = 'block';
    } else {
        quillButtons.style.display = 'none';
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('imageSizeModal'));
    modal.show();
}

// Function to insert image into Quill editor
function insertImageIntoQuill(imageUrl, altText, titleText) {
    if (window.currentQuillEditor) {
        const range = window.currentQuillEditor.getSelection();
        const index = range ? range.index : window.currentQuillEditor.getLength();
        
        // Insert the image
        window.currentQuillEditor.insertEmbed(index, 'image', imageUrl);
        
        // Add alt and title attributes if needed
        if (altText || titleText) {
            setTimeout(() => {
                const imgElement = window.currentQuillEditor.container.querySelector('img[src="' + imageUrl + '"]');
                if (imgElement) {
                    if (altText) imgElement.alt = altText;
                    if (titleText) imgElement.title = titleText;
                }
            }, 100);
        }
        
        // Move cursor after the image
        window.currentQuillEditor.setSelection(index + 1);
        
        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('imageSizeModal'));
        if (modal) {
            modal.hide();
        }
        
        // Clear the current editor reference
        window.currentQuillEditor = null;
    }
}

// Remove template block
function removeBlock(pageTemplateId) {
    if (confirm('Are you sure you want to remove this template block?')) {
        // Use the hidden form to submit the removal
        document.getElementById('removeTemplateId').value = pageTemplateId;
        document.getElementById('removeTemplateForm').submit();
    }
}

// Add selected template
function addSelectedTemplate() {
    const select = document.getElementById('templateSelect');
    
    if (!select.value) {
        alert('Please select a template to add.');
        select.focus();
        return;
    }
    
    // Set the selected template ID in the hidden form
    document.getElementById('selectedTemplateId').value = select.value;
    
    // Submit the add template form
    document.getElementById('addTemplateForm').submit();
}

// Reinitialize sortable after new blocks are added (called after page reload)
function reinitializeSortable() {
    if (sortableBlocks) {
        sortableBlocks.destroy();
    }
    initializeSortable();
}

// CMS Block Indentation System
// Usage: Add tags like <cms:hero-1> and </cms:hero-1> to block captions
// Example:
// Block 1: "Header <cms:hero-1>"     -> Opens hero-1 section (not indented)
// Block 2: "Content"                 -> Indented (inside hero-1)
// Block 3: "Footer </cms:hero-1>"    -> Closes hero-1 section (not indented)
// Block 4: "Normal content"          -> Back to normal level
// Note: Blocks with opening tags, closing tags, or both are not indented themselves
function parseCMSTags(caption) {
    if (!caption) return { openTags: [], closeTags: [] };
    
    const openTags = [];
    const closeTags = [];
    
    // Find opening tags like <cms:hero-1>
    const openTagRegex = /<cms:([^>]+)>/g;
    let match;
    while ((match = openTagRegex.exec(caption)) !== null) {
        openTags.push(match[1]);
    }
    
    // Find closing tags like </cms:hero-1>
    const closeTagRegex = /<\/cms:([^>]+)>/g;
    while ((match = closeTagRegex.exec(caption)) !== null) {
        closeTags.push(match[1]);
    }
    
    return { openTags, closeTags };
}

function calculateBlockIndentation() {
    const blocks = document.querySelectorAll('.template-block');
    const indentationStack = [];
    
    blocks.forEach((block, index) => {
        // Remove existing indentation classes and tag indicators
        block.classList.remove('indented', 'indent-level-1', 'indent-level-2', 'indent-level-3', 'indent-level-4', 'indent-level-5');
        
        // Remove existing tag indicators
        const existingIndicators = block.querySelectorAll('.cms-tag-indicator');
        existingIndicators.forEach(indicator => indicator.remove());
        
        const titleInput = block.querySelector('.editable-title');
        if (!titleInput) return;
        
        const caption = titleInput.value || titleInput.placeholder || '';
        const { openTags, closeTags } = parseCMSTags(caption);
        
        // Add visual indicators for CMS tags to the right side
        const rightSideDiv = block.querySelector('.d-flex.gap-1');
        if (rightSideDiv) {
            // Insert CMS tag indicators at the beginning of the right side div
            openTags.forEach(tag => {
                const indicator = document.createElement('span');
                indicator.className = 'cms-tag-indicator open-tag';
                indicator.textContent = `+${tag}`;
                indicator.title = `Opening tag: <cms:${tag}>`;
                rightSideDiv.insertBefore(indicator, rightSideDiv.firstChild);
            });
            
            closeTags.forEach(tag => {
                const indicator = document.createElement('span');
                indicator.className = 'cms-tag-indicator close-tag';
                indicator.textContent = `-${tag}`;
                indicator.title = `Closing tag: </cms:${tag}>`;
                rightSideDiv.insertBefore(indicator, rightSideDiv.firstChild);
            });
        }
        
        // Check if this block has opening tags, closing tags, or both (should not be indented)
        const hasOpeningTags = openTags.length > 0;
        const hasClosingTags = closeTags.length > 0;
        const hasBothTags = hasOpeningTags && hasClosingTags;
        
        // Apply indentation based on stack depth (but not if block has opening or closing tags)
        const indentLevel = indentationStack.length;
        if (indentLevel > 0 && !hasOpeningTags && !hasClosingTags) {
            block.classList.add('indented');
            if (indentLevel <= 5) {
                block.classList.add(`indent-level-${indentLevel}`);
            } else {
                // For deeper nesting, use CSS custom property
                block.style.setProperty('--indent-level', indentLevel);
                block.style.marginLeft = `${indentLevel * 50}px`;
            }
        }
        
        // Process opening tags (add to stack)
        openTags.forEach(tag => {
            indentationStack.push(tag);
        });
        
        // Process closing tags (remove from stack)
        closeTags.forEach(tag => {
            const tagIndex = indentationStack.lastIndexOf(tag);
            if (tagIndex !== -1) {
                indentationStack.splice(tagIndex, 1);
            }
        });
    });
}

// Apply indentation when page loads
function initializeIndentation() {
    calculateBlockIndentation();
    
    // Recalculate when title inputs change
    document.querySelectorAll('.editable-title').forEach(input => {
        input.addEventListener('input', calculateBlockIndentation);
        input.addEventListener('blur', calculateBlockIndentation);
    });
}

// Validate template selection before adding (for form onsubmit)
function validateTemplateSelection(form) {
    const templateId = document.getElementById('selectedTemplateId').value;
    
    if (!templateId) {
        alert('Please select a template to add.');
        return false;
    }
    
    return true;
}

// Toggle block content visibility
function toggleBlockContent(blockId) {
    const contentDiv = document.getElementById('content-' + blockId);
    const icon = document.getElementById('expand-icon-' + blockId);
    
    if (contentDiv.classList.contains('show')) {
        // Collapse
        contentDiv.classList.remove('show');
        icon.style.transform = 'rotate(0deg)';
    } else {
        // Expand
        contentDiv.classList.add('show');
        icon.style.transform = 'rotate(180deg)';
        
        // Refresh CodeMirror if it exists for this block
        setTimeout(() => {
            const textarea = document.getElementById('template_' + blockId);
            if (textarea && textarea.nextElementSibling && textarea.nextElementSibling.CodeMirror) {
                textarea.nextElementSibling.CodeMirror.refresh();
            }
        }, 100);
    }
}

// Generate slug from title
function generateSlug() {
    const titleInput = document.getElementById('page_title');
    const slugInput = document.getElementById('page_slug');
    
    if (titleInput && slugInput) {
        // Only auto-generate if slug is empty or matches the previous title
        const currentTitle = titleInput.value;
        const currentSlug = slugInput.value;
        
        // Simple slug generation (convert to lowercase, replace spaces with hyphens, remove special chars)
        const generatedSlug = currentTitle
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '') // Remove special characters except spaces and hyphens
            .replace(/\s+/g, '-') // Replace spaces with hyphens
            .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen
            .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens
        
        // Only update if slug is empty or if it looks like it was auto-generated
        if (!currentSlug || currentSlug === slugifyPreviousTitle) {
            slugInput.value = generatedSlug;
        }
        
        // Store the current title for next comparison
        slugifyPreviousTitle = currentTitle;
    }
}

// Store previous title for slug generation comparison
let slugifyPreviousTitle = '';

// Validate page form before submission
function validatePageForm() {
    const titleInput = document.getElementById('page_title');
    const slugInput = document.getElementById('page_slug');
    
    if (!titleInput || !slugInput) {
        return true; // Let server handle validation if elements not found
    }
    
    const title = titleInput.value.trim();
    const slug = slugInput.value.trim();
    
    if (!title) {
        alert('Page title is required');
        titleInput.focus();
        return false;
    }
    
    if (!slug) {
        alert('Page slug is required');
        slugInput.focus();
        return false;
    }
    
    // Validate slug format (only lowercase letters, numbers, and hyphens)
    const slugPattern = /^[a-z0-9-]+$/;
    if (!slugPattern.test(slug)) {
        alert('Page slug can only contain lowercase letters, numbers, and hyphens');
        slugInput.focus();
        return false;
    }
    
    // Check for consecutive hyphens or leading/trailing hyphens
    if (slug.includes('--') || slug.startsWith('-') || slug.endsWith('-')) {
        alert('Page slug cannot have consecutive hyphens or start/end with hyphens');
        slugInput.focus();
        return false;
    }
    
    return true;
}
</script>
<!-- Quill.js for WYSIWYG editing -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/neo.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize drag and drop sorting
    initializeSortable();
    
    // Initialize CMS block indentation
    initializeIndentation();
    
    let wysiwygToggleState = {};

    // Initialize Quill WYSIWYG editors
    if (window.Quill) {
        document.querySelectorAll('.quill-container').forEach(function(container) {
            const textarea = container.nextElementSibling;
            if (textarea && textarea.classList.contains('wysiwyg-textarea')) {
                // Initialize Quill editor
                const quill = new Quill(container, {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: [
                                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                [{ 'indent': '-1'}, { 'indent': '+1' }],
                                [{ 'align': [] }],
                                ['link', 'blockquote', 'code-block'],
                                ['image'], // Add image button
                                ['clean']
                            ],
                            handlers: {
                                'image': function() {
                                    // Store reference to this Quill instance for image insertion
                                    window.currentQuillEditor = quill;
                                    openMediaPicker();
                                }
                            }
                        }
                    },
                    placeholder: textarea.placeholder || 'Enter content...'
                });
                
                // Set initial content from textarea
                const initialContent = textarea.value || '';
                if (initialContent) {
                    quill.root.innerHTML = initialContent;
                }
                
                // Store reference to Quill instance
                container._quill = quill;

                // Default to editor mode
                wysiwygToggleState[textarea.name] = 'visual';
                
                // Update textarea when Quill content changes
                quill.on('text-change', function() {
                    textarea.value = quill.root.innerHTML;
                });
            }
        });
    }
    
    // Attach toggle handlers for Edit HTML buttons
    document.querySelectorAll('.toggle-wysiwyg-code').forEach(function(button) {
        button.addEventListener('click', function() {
            const quillId = button.getAttribute('data-quill-id');
            const container = document.getElementById(quillId);
            if (!container) { return; }

            const wrapper = container.closest('.wysiwyg-editor');
            const textarea = container.nextElementSibling;
            if (!textarea) { return; }

            const currentMode = wysiwygToggleState[textarea.name] || 'visual';

            if (currentMode === 'visual') {
                // Switch to code mode
                wrapper.classList.add('edit-html-mode');
                if (container._quill) {
                    textarea.value = container._quill.root.innerHTML;
                    container._quill.enable(false);
                }
                button.innerHTML = '<i class="bi bi-eye"></i> Back to Editor';
                wysiwygToggleState[textarea.name] = 'code';
            } else {
                // Switch back to visual mode
                wrapper.classList.remove('edit-html-mode');
                if (container._quill) {
                    container._quill.root.innerHTML = textarea.value;
                    container._quill.enable(true);
                    container._quill.focus();
                }
                button.innerHTML = '<i class="bi bi-code-slash"></i> Edit HTML';
                wysiwygToggleState[textarea.name] = 'visual';
            }
        });
    });

    if (window.CodeMirror) {
        // Initialize CodeMirror for template code editors
        document.querySelectorAll('textarea.code-html').forEach(function(ta) {
            const cm = CodeMirror.fromTextArea(ta, {
                lineNumbers: true,
                mode: 'text/html',
                theme: 'neo',
                viewportMargin: Infinity,
                readOnly: ta.hasAttribute('readonly'),
                gutters: ['CodeMirror-linenumbers']
            });
            // Keep a handle to the CM instance for later toggling readOnly
            ta._cm = cm;
            // Hide original textarea to prevent double fields
            ta.style.display = 'none';
            
            // Ensure proper gutter spacing
            setTimeout(() => {
                cm.refresh();
            }, 100);
        });
        
        // Initialize CodeMirror for parameter code editors
        document.querySelectorAll('textarea.code-html[class*="param"]').forEach(function(ta) {
            const cm = CodeMirror.fromTextArea(ta, {
                lineNumbers: true,
                mode: 'text/html',
                theme: 'neo',
                viewportMargin: Infinity,
                lineWrapping: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: true,
                gutters: ['CodeMirror-linenumbers']
            });
            // Keep a handle to the CM instance
            ta._cm = cm;
            // Hide original textarea
            ta.style.display = 'none';
            
            // Apply Bootstrap form control styling
            cm.getWrapperElement().style.border = '1px solid #ced4da';
            cm.getWrapperElement().style.borderRadius = '0.375rem';
            cm.getWrapperElement().style.fontSize = '0.875rem';
            
            // Ensure proper gutter spacing
            setTimeout(() => {
                cm.refresh();
            }, 100);
        });
        
        // Ensure CodeMirror values are saved back to textareas on submit
        const form = document.getElementById('pageForm');
        if (form) {
            form.addEventListener('submit', function() {
                // Save CodeMirror content
                document.querySelectorAll('textarea.code-html').forEach(function(ta) {
                    if (ta._cm) { ta._cm.save(); }
                });
                
                // Save Quill content
                document.querySelectorAll('.quill-container').forEach(function(container) {
                    if (container._quill) {
                        const textarea = container.nextElementSibling;
                        if (textarea && textarea.classList.contains('wysiwyg-textarea')) {
                            textarea.value = container._quill.root.innerHTML;
                        }
                    }
                });
            });
        }
    }
});

// Remove featured image function
function removeFeaturedImage() {
    if (confirm('Remove featured image? This action cannot be undone.')) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.href;
        
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'remove_featured';
        
        form.appendChild(actionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// Copy to clipboard function for featured image URLs
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.value;
    
    if (navigator.clipboard && window.isSecureContext) {
        // Use modern clipboard API
        navigator.clipboard.writeText(text).then(function() {
            showCopySuccess(element);
        }).catch(function() {
            fallbackCopyTextToClipboard(text, element);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(text, element);
    }
}

function fallbackCopyTextToClipboard(text, element) {
    element.select();
    element.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(element);
        } else {
            showCopyError(element);
        }
    } catch (err) {
        showCopyError(element);
    }
}

function showCopySuccess(element) {
    const button = element.nextElementSibling;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-check"></i>';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-success');
    
    setTimeout(function() {
        button.innerHTML = originalHTML;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
    }, 1500);
}

function showCopyError(element) {
    const button = element.nextElementSibling;
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="bi bi-x"></i>';
    button.classList.remove('btn-outline-secondary');
    button.classList.add('btn-danger');
    
    setTimeout(function() {
        button.innerHTML = originalHTML;
        button.classList.remove('btn-danger');
        button.classList.add('btn-outline-secondary');
    }, 1500);
}
</script>
{% endblock %}
