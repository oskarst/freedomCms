{% extends "base.html" %}
{% set title = "File Manager" %}

{% block content %}
<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3">File Manager</h1>
    <a class="btn btn-outline-secondary" href="{{ url_for('files.list_dir') }}">Root</a>
  </div>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('files.list_dir') }}">pub</a></li>
      {% for c in breadcrumbs %}
        <li class="breadcrumb-item {% if loop.last %}active{% endif %}" {% if loop.last %}aria-current="page"{% endif %}>
          {% if loop.last %}{{ c.name }}{% else %}
            <a href="{{ url_for('files.list_dir', path=c.path) }}">{{ c.name }}</a>
          {% endif %}
        </li>
      {% endfor %}
    </ol>
  </nav>

  <div class="card mb-3">
    <div class="card-body">
      <form class="row g-2" method="post" enctype="multipart/form-data" action="{{ url_for('files.list_dir', path=rel_path) }}">
        <input type="hidden" name="action" value="upload">
        <div class="col-md-6">
          <input type="file" name="file" class="form-control" required>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary" type="submit"><i class="bi bi-upload"></i> Upload</button>
        </div>
      </form>
      <hr>
      <form class="row g-2" method="post" action="{{ url_for('files.list_dir', path=rel_path) }}">
        <input type="hidden" name="action" value="new_folder">
        <div class="col-md-4">
          <input type="text" name="folder_name" class="form-control" placeholder="New folder name" required>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-primary" type="submit"><i class="bi bi-folder-plus"></i> New Folder</button>
        </div>
      </form>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>Name</th>
          <th>Size</th>
          <th>Modified</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if rel_path %}
        <tr>
          <td colspan="4"><a href="{{ url_for('files.list_dir', path=rel_path.rsplit('/',1)[0]) }}"><i class="bi bi-arrow-up"></i> Parent directory</a></td>
        </tr>
        {% endif %}
        {% for e in entries %}
        <tr>
          <td>
            {% if e.is_dir %}
              <i class="bi bi-folder-fill text-warning"></i>
              <a href="{{ url_for('files.list_dir', path=e.rel) }}">{{ e.name }}</a>
            {% else %}
              <i class="bi bi-file-earmark"></i> {{ e.name }}
            {% endif %}
          </td>
          <td>{{ e.size if e.size is not none else '' }}</td>
          <td>{{ e.mtime|int }}</td>
          <td class="text-end">
            {% if not e.is_dir %}
              <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('files.edit_file', path=e.rel) }}"><i class="bi bi-pencil"></i> Edit</a>
            {% endif %}
            <form class="d-inline" method="post" action="{{ url_for('files.list_dir', path=rel_path) }}" onsubmit="return confirm('Delete {{ e.is_dir and 'folder' or 'file' }} {{ e.name }}?')">
              <input type="hidden" name="action" value="delete">
              <input type="hidden" name="target_name" value="{{ e.name }}">
              <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
            </form>
            <form class="d-inline" method="post" action="{{ url_for('files.list_dir', path=rel_path) }}">
              <input type="hidden" name="action" value="rename">
              <input type="hidden" name="old_name" value="{{ e.name }}">
              <div class="input-group input-group-sm" style="width: 260px; display: inline-flex; vertical-align: middle;">
                <input type="text" name="new_name" class="form-control" placeholder="Rename to...">
                <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-arrow-return-right"></i></button>
              </div>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}


